name: CD - Deploy to VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  VPS_USER: ${{ secrets.VPS_USER }}
  VPS_HOST: ${{ secrets.VPS_HOST }}
  VPS_DEPLOY_DIR: /opt/pzem-monitoring
  DOMAIN: pzem.moof-set.web.id

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

    - name: Add VPS to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
        chmod 600 ~/.ssh/known_hosts

    - name: Create deployment package
      run: |
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        PACKAGE_NAME="pzem-monitoring-deploy-${TIMESTAMP}.tar.gz"
        
        # Create package
        tar -czf ${PACKAGE_NAME} \
          dashboard/ \
          mqtt/ \
          docker-compose.yml \
          start.sh \
          nginx-pzem.conf \
          setup-nginx-ssl.sh \
          *.md \
          .github/
        
        echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV
        echo "Package created: ${PACKAGE_NAME}"

    - name: Upload package to VPS
      run: |
        scp -o StrictHostKeyChecking=no ${PACKAGE_NAME} ${VPS_USER}@${VPS_HOST}:/tmp/
        echo "Package uploaded to VPS"

    - name: Create remote deployment script
      run: |
        cat > /tmp/remote-deploy-ci.sh << 'REMOTE_SCRIPT'
        #!/bin/bash
        set -e
        
        VPS_DEPLOY_DIR="/opt/pzem-monitoring"
        BACKUP_DIR="/opt/backups/pzem-monitoring"
        PACKAGE_FILE=$(ls /tmp/pzem-monitoring-deploy-*.tar.gz | head -1)
        
        # Detect docker-compose
        if command -v docker-compose &> /dev/null; then
          DOCKER_COMPOSE="docker-compose"
        elif docker compose version &> /dev/null; then
          DOCKER_COMPOSE="docker compose"
        else
          echo "ERROR: docker-compose not found"
          exit 1
        fi
        
        echo "üîß Starting deployment..."
        
        # Backup existing (if exists)
        if [ -d "${VPS_DEPLOY_DIR}" ]; then
          echo "üì¶ Creating backup..."
          mkdir -p "${BACKUP_DIR}"
          
          if [ -f "${VPS_DEPLOY_DIR}/docker-compose.yml" ]; then
            cd "${VPS_DEPLOY_DIR}"
            
            # Backup database if container running
            if docker ps | grep -q "pzem-monitoring.*db\|.*db.*pzem"; then
              DB_CONTAINER=$(docker ps | grep -E "pzem-monitoring.*db|.*db.*pzem" | awk '{print $1}' | head -1)
              if [ -n "$DB_CONTAINER" ]; then
                docker exec ${DB_CONTAINER} pg_dump -U postgres pzem_monitoring > "${BACKUP_DIR}/database_backup_$(date +%Y%m%d_%H%M%S).sql" 2>/dev/null || true
              fi
            fi
            
            # Backup .env
            if [ -f "${VPS_DEPLOY_DIR}/.env" ]; then
              cp "${VPS_DEPLOY_DIR}/.env" "${BACKUP_DIR}/.env.backup.$(date +%Y%m%d_%H%M%S)"
            fi
            
            # Stop services (preserve volumes)
            $DOCKER_COMPOSE down 2>/dev/null || true
          fi
          
          # Backup directory
          BACKUP_NAME="${VPS_DEPLOY_DIR}_backup_$(date +%Y%m%d_%H%M%S)"
          mv "${VPS_DEPLOY_DIR}" "${BACKUP_NAME}" || true
        fi
        
        # Extract new package
        echo "üì¶ Extracting package..."
        cd /opt
        tar -xzf "${PACKAGE_FILE}"
        
        # Restore .env if exists
        if [ -f "${BACKUP_DIR}/.env.backup."* ]; then
          LATEST_ENV=$(ls -t "${BACKUP_DIR}/.env.backup."* | head -1)
          cp "${LATEST_ENV}" "${VPS_DEPLOY_DIR}/.env"
          echo "‚úÖ .env restored from backup"
        else
          echo "‚ö†Ô∏è  No .env backup found - using template"
        fi
        
        # Make scripts executable
        chmod +x ${VPS_DEPLOY_DIR}/*.sh 2>/dev/null || true
        
        # Build and start
        echo "üî® Building containers..."
        cd "${VPS_DEPLOY_DIR}"
        $DOCKER_COMPOSE build
        
        echo "üöÄ Starting services..."
        $DOCKER_COMPOSE up -d
        
        # Wait for services
        echo "‚è≥ Waiting for services..."
        sleep 15
        
        # Verify database
        echo "üîç Verifying database..."
        MAX_RETRIES=30
        RETRY_COUNT=0
        DB_READY=false
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          if $DOCKER_COMPOSE exec -T db pg_isready -U postgres > /dev/null 2>&1; then
            DB_READY=true
            break
          fi
          RETRY_COUNT=$((RETRY_COUNT + 1))
          sleep 2
        done
        
        if [ "$DB_READY" = true ]; then
          echo "‚úÖ Database is ready"
        else
          echo "‚ùå Database did not become ready"
          exit 1
        fi
        
        # Health check
        echo "üè• Health check..."
        sleep 5
        if curl -f -s http://localhost:5000/health > /dev/null 2>&1; then
          echo "‚úÖ Health check passed"
        else
          echo "‚ö†Ô∏è  Health check failed (may still be starting)"
        fi
        
        # Cleanup
        rm -f "${PACKAGE_FILE}"
        
        echo "‚úÖ Deployment completed!"
        REMOTE_SCRIPT
        
        scp -o StrictHostKeyChecking=no /tmp/remote-deploy-ci.sh ${VPS_USER}@${VPS_HOST}:/tmp/

    - name: Execute deployment on VPS
      run: |
        ssh -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} "chmod +x /tmp/remote-deploy-ci.sh && bash /tmp/remote-deploy-ci.sh"

    - name: Verify deployment
      run: |
        ssh -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} << 'EOF'
          cd ${VPS_DEPLOY_DIR}
          docker-compose ps
          echo ""
          echo "üìä Service Status:"
          docker-compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
        EOF

    - name: Cleanup local files
      if: always()
      run: |
        rm -f ${PACKAGE_NAME}
        rm -f /tmp/remote-deploy-ci.sh

    - name: Deployment summary
      if: always()
      run: |
        echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **VPS**: ${VPS_USER}@${VPS_HOST}" >> $GITHUB_STEP_SUMMARY
        echo "- **Domain**: ${DOMAIN}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Access URLs" >> $GITHUB_STEP_SUMMARY
        echo "- Dashboard: http://${VPS_HOST}:5000" >> $GITHUB_STEP_SUMMARY
        echo "- Domain: https://${DOMAIN}" >> $GITHUB_STEP_SUMMARY
        echo "- Health: http://${VPS_HOST}:5000/health" >> $GITHUB_STEP_SUMMARY


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZEM Energy Monitoring Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
        }

        .stat-icon.devices { background: linear-gradient(45deg, #4CAF50, #45a049); }
        .stat-icon.power { background: linear-gradient(45deg, #FF9800, #f57c00); }
        .stat-icon.energy { background: linear-gradient(45deg, #2196F3, #1976D2); }
        .stat-icon.online { background: linear-gradient(45deg, #9C27B0, #7B1FA2); }

        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 20px;
            align-items: center;
        }

        .device-selector select,
        .period-selector select {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            font-size: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .device-selector select:focus,
        .period-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .refresh-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            height: 500px;
        }

        .chart-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: calc(100% - 60px);
        }

        .device-list {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            max-height: 500px;
            overflow-y: auto;
        }

        .device-list h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .device-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .device-item:hover {
            background: #e3f2fd;
            border-color: #2196F3;
        }

        .device-item.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .device-name {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .device-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.85rem;
        }

        .data-table {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .table-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 400px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e3f2fd;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-online { background-color: #4CAF50; }
        .status-offline { background-color: #f44336; }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .last-update {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #666;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-bolt"></i> PZEM Energy Monitoring</h1>
            <p>Real-time Power Consumption Dashboard</p>
        </div>

        <!-- System Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon devices">
                    <i class="fas fa-microchip"></i>
                </div>
                <div class="stat-value" id="totalDevices">0</div>
                <div class="stat-label">Total Devices</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon online">
                    <i class="fas fa-wifi"></i>
                </div>
                <div class="stat-value" id="onlineDevices">0</div>
                <div class="stat-label">Online Devices</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon power">
                    <i class="fas fa-lightning-bolt"></i>
                </div>
                <div class="stat-value" id="totalPower">0 W</div>
                <div class="stat-label">Total Power</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon energy">
                    <i class="fas fa-battery-three-quarters"></i>
                </div>
                <div class="stat-value" id="totalEnergy">0 kWh</div>
                <div class="stat-label">Total Energy</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-grid">
                <div class="device-selector">
                    <select id="deviceSelect">
                        <option value="">Loading devices...</option>
                    </select>
                </div>
                <div class="period-selector">
                    <select id="periodSelect">
                        <option value="hour">Last Hour</option>
                        <option value="day">Last Day</option>
                        <option value="week">Last Week</option>
                        <option value="month">Last Month</option>
                    </select>
                </div>
                <button class="refresh-btn" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Chart Container -->
            <div class="chart-container">
                <div class="chart-title">Power Consumption Chart</div>
                <div class="chart-wrapper">
                    <canvas id="powerChart"></canvas>
                </div>
            </div>

            <!-- Device List -->
            <div class="device-list">
                <h3>Active Devices</h3>
                <div id="deviceListContainer">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading devices...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="data-table">
            <div class="table-title">Recent Data Records</div>
            <div class="table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Device</th>
                            <th>Time</th>
                            <th>Voltage (V)</th>
                            <th>Current (A)</th>
                            <th>Power (W)</th>
                            <th>Energy (kWh)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <tr>
                            <td colspan="7" class="loading">
                                <i class="fas fa-spinner"></i>
                                Loading data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Last Update Indicator -->
    <div class="last-update" id="lastUpdate">
        Last update: Never
    </div>

    <script>
        // Global variables
        let chart = null;
        let socket = null;
        let currentDevice = '';
        let currentPeriod = 'hour';
        let devices = [];
        let latestData = {};

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocketIO();
            initializeChart();
            loadSystemStatus();
            loadDevices();
            
            // Set up event listeners
            document.getElementById('deviceSelect').addEventListener('change', onDeviceChange);
            document.getElementById('periodSelect').addEventListener('change', onPeriodChange);
            
            // Auto refresh every 30 seconds
            setInterval(refreshData, 30000);
        });

        // Initialize Socket.IO connection
        function initializeSocketIO() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
                updateLastUpdate();
            });
            
            socket.on('data_update', function(data) {
                latestData = data;
                updateSystemStatus();
                updateDeviceList();
                updateDataTable();
                if (currentDevice && data[currentDevice]) {
                    updateChart();
                }
                updateLastUpdate();
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from server');
            });
        }

        // Initialize Chart.js
        function initializeChart() {
            const ctx = document.getElementById('powerChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Power (W)',
                            data: [],
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Voltage (V)',
                            data: [],
                            borderColor: 'rgb(255, 152, 0)',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Current (A)',
                            data: [],
                            borderColor: 'rgb(76, 175, 80)',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Power (W)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: false,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Voltage (V)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        },
                        y2: {
                            type: 'linear',
                            display: false,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Current (A)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        }

        // Load system status
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/system-status');
                const data = await response.json();
                updateSystemStatusDisplay(data);
            } catch (error) {
                console.error('Error loading system status:', error);
            }
        }

        // Update system status from live data
        function updateSystemStatus() {
            const deviceCount = Object.keys(latestData).length;
            let onlineCount = 0;
            let totalPower = 0;
            let totalEnergy = 0;

            Object.values(latestData).forEach(device => {
                const lastSeen = new Date(device.created_at);
                const isOnline = (Date.now() - lastSeen.getTime()) < 10 * 60 * 1000; // 10 minutes
                
                if (isOnline) onlineCount++;
                totalPower += device.avg_power || 0;
                totalEnergy += device.total_energy || 0;
            });

            updateSystemStatusDisplay({
                total_devices: deviceCount,
                online_devices: onlineCount,
                total_power: totalPower,
                total_energy: totalEnergy
            });
        }

        // Update system status display
        function updateSystemStatusDisplay(data) {
            document.getElementById('totalDevices').textContent = data.total_devices;
            document.getElementById('onlineDevices').textContent = data.online_devices;
            document.getElementById('totalPower').textContent = `${data.total_power.toFixed(1)} W`;
            document.getElementById('totalEnergy').textContent = `${data.total_energy.toFixed(2)} kWh`;
        }

        // Load devices
        async function loadDevices() {
            try {
                const response = await fetch('/api/devices');
                devices = await response.json();
                
                const deviceSelect = document.getElementById('deviceSelect');
                deviceSelect.innerHTML = '<option value="">All Devices</option>';
                
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device[0];
                    option.textContent = `Device ${device[0]} (${device[1]} records)`;
                    deviceSelect.appendChild(option);
                });

                // Load latest data for all devices
                await loadLatestData();
                updateDeviceList();
                updateDataTable();
                
            } catch (error) {
                console.error('Error loading devices:', error);
            }
        }

        // Load latest data for all devices
        async function loadLatestData() {
            try {
                const response = await fetch('/api/all-latest');
                latestData = await response.json();
            } catch (error) {
                console.error('Error loading latest data:', error);
            }
        }

        // Update device list
        function updateDeviceList() {
            const container = document.getElementById('deviceListContainer');
            
            if (Object.keys(latestData).length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>No device data available</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            
            Object.keys(latestData).forEach(deviceAddress => {
                const data = latestData[deviceAddress];
                const deviceItem = document.createElement('div');
                deviceItem.className = 'device-item';
                if (deviceAddress === currentDevice) {
                    deviceItem.classList.add('active');
                }
                
                deviceItem.onclick = () => selectDevice(deviceAddress);
                
                const lastSeen = new Date(data.created_at);
                const isOnline = (Date.now() - lastSeen.getTime()) < 10 * 60 * 1000; // 10 minutes
                
                deviceItem.innerHTML = `
                    <div class="device-name">
                        <span class="status-indicator ${isOnline ? 'status-online' : 'status-offline'}"></span>
                        Device ${deviceAddress}
                    </div>
                    <div class="device-stats">
                        <div>Power: ${(data.avg_power || 0).toFixed(1)} W</div>
                        <div>Voltage: ${(data.avg_voltage || 0).toFixed(1)} V</div>
                        <div>Current: ${(data.avg_current || 0).toFixed(2)} A</div>
                        <div>Energy: ${(data.total_energy || 0).toFixed(2)} kWh</div>
                    </div>
                `;
                
                container.appendChild(deviceItem);
            });
        }

        // Select device
        function selectDevice(deviceAddress) {
            currentDevice = deviceAddress;
            document.getElementById('deviceSelect').value = deviceAddress;
            updateChart();
            updateDeviceList();
        }

        // Update chart
        async function updateChart() {
            if (!currentDevice) {
                chart.data.labels = [];
                chart.data.datasets[0].data = [];
                chart.data.datasets[1].data = [];
                chart.data.datasets[2].data = [];
                chart.update();
                return;
            }
            
            try {
                const response = await fetch(`/api/chart/${currentDevice}?period=${currentPeriod}`);
                const data = await response.json();
                
                const labels = data.map(item => {
                    const date = new Date(item.time_period);
                    return date.toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                });
                
                const powerData = data.map(item => item.power || 0);
                const voltageData = data.map(item => item.voltage || 0);
                const currentData = data.map(item => item.current || 0);
                
                chart.data.labels = labels;
                chart.data.datasets[0].data = powerData;
                chart.data.datasets[1].data = voltageData;
                chart.data.datasets[2].data = currentData;
                
                chart.update();
                
            } catch (error) {
                console.error('Error updating chart:', error);
            }
        }

        // Update data table
        function updateDataTable() {
            const tbody = document.getElementById('dataTableBody');
            
            if (Object.keys(latestData).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-data">No data available</td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            // Sort devices by latest data
            const sortedDevices = Object.keys(latestData).sort((a, b) => {
                return new Date(latestData[b].created_at) - new Date(latestData[a].created_at);
            });
            
            sortedDevices.slice(0, 20).forEach(deviceAddress => {
                const data = latestData[deviceAddress];
                const row = document.createElement('tr');
                
                const lastSeen = new Date(data.created_at);
                const isOnline = (Date.now() - lastSeen.getTime()) < 10 * 60 * 1000; // 10 minutes
                
                row.innerHTML = `
                    <td>Device ${deviceAddress}</td>
                    <td>${formatDate(lastSeen)}</td>
                    <td>${(data.avg_voltage || 0).toFixed(1)}</td>
                    <td>${(data.avg_current || 0).toFixed(2)}</td>
                    <td>${(data.avg_power || 0).toFixed(1)}</td>
                    <td>${(data.total_energy || 0).toFixed(2)}</td>
                    <td>
                        <span class="status-indicator ${isOnline ? 'status-online' : 'status-offline'}"></span>
                        ${isOnline ? 'Online' : 'Offline'}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Event handlers
        function onDeviceChange() {
            currentDevice = document.getElementById('deviceSelect').value;
            updateChart();
            updateDeviceList();
        }

        function onPeriodChange() {
            currentPeriod = document.getElementById('periodSelect').value;
            if (currentDevice) {
                updateChart();
            }
        }

        // Refresh all data
        async function refreshData() {
            await loadSystemStatus();
            await loadDevices();
            if (currentDevice) {
                await updateChart();
            }
            updateLastUpdate();
        }

        // Utility functions
        function formatDate(date) {
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function updateLastUpdate() {
            document.getElementById('lastUpdate').textContent = 
                `Last update: ${new Date().toLocaleTimeString()}`;
        }
    </script>
</body>
</html>